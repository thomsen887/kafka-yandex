# –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞¬†5¬†‚Äî Debezium¬†CDC + Kafka + Prometheus/Grafana

–í¬†—ç—Ç–æ–π —Ä–∞–±–æ—Ç–µ –º—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫–æ–≤—É—é —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ PostgreSQL –≤¬†Kafka, –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä Debezium, –∞¬†—Ç–∞–∫–∂–µ –ø–æ–¥–∫–ª—é—á–∞–µ–º Prometheus –∏¬†Grafana –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.  –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∏¬†–∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤¬†Docker Compose, –ø–æ—ç—Ç–æ–º—É –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ Docker¬†Engine.

## üì¶ –°–æ—Å—Ç–∞–≤ —Ä–µ—à–µ–Ω–∏—è

–í –∫–∞—Ç–∞–ª–æ–≥–µ¬†`practic5` –Ω–∞—Ö–æ–¥—è—Ç—Å—è —Ñ–∞–π–ª—ã –∏¬†–∫–∞—Ç–∞–ª–æ–≥–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞:

| –ü—É—Ç—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| `docker-compose.yaml` | –û–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã ‚Äî Kafka, Kafka¬†Connect, PostgreSQL, Prometheus –∏¬†Grafana. |
| `postgres/` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PostgreSQL.  –í¬†—Ñ–∞–π–ª–µ `custom-config.conf` –≤–∫–ª—é—á—ë–Ω –ª–æ–≥–∏—á–µ—Å–∫–∏–π –∂—É—Ä–Ω–∞–ª (`wal_level = logical`), –∞¬†`init.sql` —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã `users` –∏¬†`orders` –∏¬†–∑–∞–ø–æ–ª–Ω—è–µ—Ç –∏—Ö —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. |
| `kafka-connect/` | –°–æ–¥–µ—Ä–∂–∏—Ç Dockerfile –∏¬†–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ JMX‚Äë—ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–∞ –¥–ª—è Kafka¬†Connect (`kafka-connect.yml` –∏¬†`jmx_prometheus_javaagent-0.19.0.jar`).  –ü–∞–ø–∫–∞ `confluent-hub-components` –≤–∫–ª—é—á–∞–µ—Ç –ø–ª–∞–≥–∏–Ω Debezium –¥–ª—è PostgreSQL. |
| `prometheus/prometheus.yml` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Prometheus, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–±–∏—Ä–∞–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏¬†–º–µ—Ç—Ä–∏–∫–∏ Kafka¬†Connect. |
| `grafana/` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Grafana: datasource —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ Prometheus, –∞¬†–¥–µ—à–±–æ—Ä–¥ `connect.json` –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤. |
| `consumer/` | –ö–æ–Ω—Å—å—é–º–µ—Ä –Ω–∞ golang |
| `connector.json` | JSON‚Äë–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞ Debezium, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—â–µ–≥–æ —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü—ã `users` –∏¬†`orders` –≤¬†–±–∞–∑–µ `demo_db`. |


## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. **–°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏¬†–ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤¬†–∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–∞–∫—Ç–∏–∫–∏.**

   ```bash
   git clone https://github.com/thomsen887/kafka‚Äëyandex.git
   cd kafka‚Äëyandex/practic5
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É.**
   Docker Compose —Å–æ–∑–¥–∞—Å—Ç –∏¬†–∑–∞–ø—É—Å—Ç–∏—Ç –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: –±—Ä–æ–∫–µ—Ä Kafka, –±–∞–∑—É PostgreSQL, Kafka¬†Connect —Å¬†–ø–ª–∞–≥–∏–Ω–æ–º Debezium, –∞¬†—Ç–∞–∫–∂–µ Prometheus –∏¬†Grafana –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

   ```bash
   docker compose up -d
   ```

   –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –º–æ–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –≤¬†—Å–æ—Å—Ç–æ—è–Ω–∏–∏¬†`healthy`:

   ```bash
   docker compose ps
   ```

3. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä.**
   Debezium –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –µ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ REST¬†API Kafka¬†Connect.  –§–∞–π–ª `connector.json` —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.  –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:

   ```bash
   curl -i -X POST \
     -H "Content-Type: application/json" \
     --data @connector.json \
     http://localhost:8083/connectors
   ```

   –ï—Å–ª–∏ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä –±—ã–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω, REST¬†API –≤–µ—Ä–Ω—ë—Ç –æ–±—ä–µ–∫—Ç —Å¬†–µ–≥–æ –∏–º–µ–Ω–µ–º –∏¬†–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π.  –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–æ–∂–Ω–æ —Ç–∞–∫:

   ```bash
   curl -s http://localhost:8083/connectors/pg-users-orders-connector/status | jq
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ PostgreSQL –ø–æ—Å—Ç—É–ø–∞—é—Ç –≤¬†Kafka.**  
   ```

   –í¬†–æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫¬†PostgreSQL –∏¬†–¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –≤¬†—Ç–∞–±–ª–∏—Ü—ã `users` –∏¬†`orders`.  –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤¬†—Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:

   ```bash
   docker exec -it postgres psql -U postgres -d demo_db -c "INSERT INTO users (name, email) VALUES ('Charlie Chaplin', 'charlie@example.com');"
   docker exec -it postgres psql -U postgres -d demo_db -c "INSERT INTO orders (user_id, product_name, quantity) VALUES (5, 'Product F', 2);"
   ```

5. **–û—Ç–∫—Ä–æ–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.**

   - Prometheus –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É <http://localhost:9090>.  –í –Ω—ë–º –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫¬†–º–µ—Ç—Ä–∏–∫–∞–º, –Ω–∞–ø—Ä–∏–º–µ—Ä `kafka_connect_worker_connector_total_task_count`.
   - Grafana –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ <http://localhost:3000>.  –õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `admin/admin`.  –î–µ—à–±–æ—Ä–¥ `connect.json` –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –∏¬†–ø–æ–∫–∞–∂–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á, —Å—Ç–∞—Ç—É—Å –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞ –∏¬†–¥—Ä—É–≥–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏.


## üß∞ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### PostgreSQL

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—Ä–∞–∑ `debezium/postgres:16`, –≤¬†–∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤—Å—Ç—Ä–æ–µ–Ω –ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–ª–∞–≥–∏–Ω `pgoutput`.  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `custom-config.conf` –≤–∫–ª—é—á–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π —Ä–µ–∂–∏–º `wal_level = logical` –∏¬†–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤.  –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Postgres –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–∫—Ä–∏–ø—Ç `init.sql`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã `users` –∏¬†`orders` –∏¬†–∑–∞–ø–æ–ª–Ω—è–µ—Ç –∏—Ö —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

### Kafka –∏¬†Kafka¬†Connect

–ë—Ä–æ–∫–µ—Ä Kafka —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç –≤¬†—Ä–µ–∂–∏–º–µ KRaft –∏¬†—Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç `9092`.  –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –≤¬†—Å–µ—Ä–≤–∏—Å–µ `kafka-connect`, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –Ω–∞¬†–±–∞–∑–µ –æ–±—Ä–∞–∑–∞ `confluentinc/cp-kafka-connect`.  –í¬†–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ–ø–∏—Ä—É—é—Ç—Å—è jar‚Äë—Ñ–∞–π–ª—ã JMX‚Äë—ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–∞ –∏¬†—Ñ–∞–π–ª –ø—Ä–∞–≤–∏–ª `kafka-connect.yml`, –∫–æ—Ç–æ—Ä—ã–π –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤¬†Prometheus.  –ü–∞–ø–∫–∞ `confluent-hub-components` –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏¬†—Å–æ–¥–µ—Ä–∂–∏—Ç –ø–ª–∞–≥–∏–Ω Debezium –¥–ª—è PostgreSQL.

### Debezium¬†Connector

–§–∞–π–ª `connector.json` –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä —Å¬†–∏–º–µ–Ω–µ–º `pg-users-orders-connector`.  –í¬†–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫¬†–±–∞–∑–µ (`database.hostname`, `database.user`, `database.password`), –∏–º—è —Å–µ—Ä–≤–µ—Ä–∞ (`database.server.name = demo`) –∏¬†—Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü, –∑–∞ –∫–æ—Ç–æ—Ä—ã–º–∏ –Ω—É–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å (`table.include.list = public.users,public.orders`).  –ü–∞—Ä–∞–º–µ—Ç—Ä `transforms.unwrap.type` –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç Debezium —É–¥–∞–ª—è—Ç—å –æ–±—ë—Ä—Ç–∫—É (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ CDC), –ø—É–±–ª–∏–∫—É—è —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏.

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus¬†+¬†Grafana)

Prometheus —Å¬†–ø–æ–º–æ—â—å—é scrape‚Äë–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `kafka-connect` –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫¬†—ç–∫—Å–ø–æ—Ä—Ç—ë—Ä—É JMX –≤–Ω—É—Ç—Ä–∏ `kafka-connect` –Ω–∞¬†–ø–æ—Ä—Ç—É¬†`9876`.  –≠—Ç–∞ —Ç–æ—á–∫–∞ –æ—Ç–¥–∞—ë—Ç –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º –∏–∑ `kafka-connect.yml`.  Grafana –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Prometheus –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –∏¬†–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–æ—Ç–æ–≤—ã–π –¥–µ—à–±–æ—Ä–¥ `connect.json`, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–¥–∞—á (running/paused), –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏¬†–¥—Ä—É–≥–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏.


## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

1. –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞ –≤¬†REST API —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `RUNNING` –∏¬†–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á —Ä–∞–≤–Ω–æ¬†`1`.
2. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –≤¬†PostgreSQL ‚Äî —Å–¥–µ–ª–∞–π—Ç–µ INSERT/UPDATE/DELETE –≤¬†—Ç–∞–±–ª–∏—Ü–∞—Ö `users` –∏–ª–∏ `orders`. 
3. –í¬†Grafana –Ω–∞ –¥–µ—à–±–æ—Ä–¥–µ `Connect` –Ω–∞–±–ª—é–¥–∞–π—Ç–µ —Ä–æ—Å—Ç —Å—á—ë—Ç—á–∏–∫–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏¬†–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫.
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ consumer –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —Ç–æ–ø–∏–∫–∞. 

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∫–æ–º–∞–Ω–¥–æ–π:

```bash
docker compose down
```